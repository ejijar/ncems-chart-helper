console.log('[EMS] script starting');

// ======== CT PROTOCOLS PDF URL ========
const CT_PROTOCOLS_PDF_URL = 'https://portal.ct.gov/dph/-/media/departments-and-agencies/dph/dph/ems/pdf/statewide_protocols/2025/v20251_ctemsstatewideprotocolsfinal.pdf';

// ======== CT PROTOCOLS DATA ========
const CT_PROTOCOLS = {
  "sections": {
    "routine": {
      "name": "Routine Patient Care",
      "icon": `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
      "protocols": [
        { "id": "1.0", "name": "Routine Patient Care", "page": 12 },
        { "id": "1.1", "name": "Routine EMR Patient Care", "page": 19 },
        { "id": "1.2", "name": "Exception Protocol", "page": 16 }
      ]
    },
    "medical": {
      "name": "Medical",
      "icon": `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 21h12a2 2 0 002-2v-2H10v2a2 2 0 01-2 2zm14-14H2v7h20V7zm0-2H2V3a1 1 0 011-1h18a1 1 0 011 1v2z"/></svg>`,
      "protocols": [
        { "id": "2.0A", "name": "Abdominal Pain", "page": 21, "keywords": ["abdominal", "stomach", "belly", "gi"] },
        { "id": "2.1", "name": "Adrenal Insufficiency - Adult/Pediatric", "page": 22, "keywords": ["adrenal", "addison"] },
        { "id": "2.2", "name": "Allergic Reaction/Anaphylaxis - Adult", "page": 23, "keywords": ["allergic", "anaphylaxis", "epipen", "hives", "allergy"] },
        { "id": "2.3A", "name": "Allergic Reaction/Anaphylaxis - Pediatric", "page": 24, "keywords": ["allergic", "anaphylaxis", "epipen", "hives", "pediatric"] },
        { "id": "2.3P", "name": "Brief Resolved Unexplained Event (BRUE)", "page": 25, "keywords": ["brue", "apnea", "infant"] },
        { "id": "2.4", "name": "Alcohol/Benzodiazepine Withdrawal - Adult", "page": 26, "keywords": ["withdrawal", "alcohol", "benzo", "dt", "seizure"] },
        { "id": "2.5A", "name": "Asthma/COPD/RAD - Adult", "page": 27, "keywords": ["asthma", "copd", "respiratory", "wheeze", "breathing"] },
        { "id": "2.5P", "name": "Asthma/Bronchiolitis/Croup - Pediatric", "page": 28, "keywords": ["asthma", "croup", "bronchiolitis", "wheeze", "pediatric"] },
        { "id": "2.6", "name": "Childbirth & Newborn Care", "page": 30, "keywords": ["birth", "delivery", "newborn", "labor", "obstetric"] },
        { "id": "2.7", "name": "Behavioral Emergencies - Adult/Pediatric", "page": 32, "keywords": ["behavioral", "psych", "psychiatric", "mental health", "suicidal"] },
        { "id": "2.8A", "name": "Fever - Adult", "page": 34, "keywords": ["fever", "temperature", "infection"] },
        { "id": "2.8P", "name": "Fever - Pediatric", "page": 35, "keywords": ["fever", "temperature", "pediatric"] },
        { "id": "2.9", "name": "Hyperglycemia - Adult/Pediatric", "page": 36, "keywords": ["hyperglycemia", "diabetic", "high sugar", "dka"] },
        { "id": "2.10", "name": "Hyperthermia (Environmental) - Adult & Pediatric", "page": 37, "keywords": ["heat", "hyperthermia", "heat stroke"] },
        { "id": "2.11", "name": "Exertional Heat Stroke", "page": 38, "keywords": ["heat stroke", "exertion", "exercise"] },
        { "id": "2.11.1", "name": "Hyperkalemia", "page": 39, "keywords": ["hyperkalemia", "potassium", "dialysis"] },
        { "id": "2.12A", "name": "Hypoglycemia - Adult", "page": 40, "keywords": ["hypoglycemia", "low sugar", "diabetic", "glucose"] },
        { "id": "2.12P", "name": "Hypoglycemia - Pediatric", "page": 41, "keywords": ["hypoglycemia", "low sugar", "pediatric"] },
        { "id": "2.13", "name": "Hypothermia (Environmental) - Adult & Pediatric", "page": 42, "keywords": ["hypothermia", "cold", "freezing"] },
        { "id": "2.14", "name": "Nausea/Vomiting - Adult & Pediatric", "page": 44, "keywords": ["nausea", "vomiting", "emesis"] },
        { "id": "2.15A", "name": "Nerve Agent/Organophosphate Poisoning - Adult", "page": 45, "keywords": ["nerve agent", "organophosphate", "chemical"] },
        { "id": "2.15P", "name": "Nerve Agent/Organophosphate Poisoning - Pediatric", "page": 46, "keywords": ["nerve agent", "organophosphate", "pediatric"] },
        { "id": "2.16", "name": "Newborn Resuscitation", "page": 47, "keywords": ["newborn", "resuscitation", "delivery"] },
        { "id": "2.17", "name": "Obstetrical Emergencies", "page": 49, "keywords": ["obstetric", "pregnancy", "labor", "bleeding"] },
        { "id": "2.18", "name": "Pain Management - Adult", "page": 51, "keywords": ["pain", "analgesia", "fentanyl"] },
        { "id": "2.19A", "name": "Pain Management - Pediatric", "page": 53, "keywords": ["pain", "pediatric", "analgesia"] },
        { "id": "2.19P", "name": "Poisoning/Overdose/Substance Use Disorder - Adult", "page": 56, "keywords": ["overdose", "poisoning", "narcan", "naloxone", "opioid"] },
        { "id": "2.20A", "name": "Poisoning/Overdose/Substance Use Disorder - Pediatric", "page": 59, "keywords": ["overdose", "poisoning", "pediatric"] },
        { "id": "2.20P", "name": "Seizures - Adult", "page": 61, "keywords": ["seizure", "convulsion", "status epilepticus"] },
        { "id": "2.21A", "name": "Seizures - Pediatric", "page": 62, "keywords": ["seizure", "pediatric", "febrile"] },
        { "id": "2.21P", "name": "Septic Shock - Adult", "page": 63, "keywords": ["sepsis", "septic shock", "infection"] },
        { "id": "2.22A", "name": "Septic Shock - Pediatric", "page": 64, "keywords": ["sepsis", "pediatric"] },
        { "id": "2.22P", "name": "Shock (Non-Traumatic)", "page": 65, "keywords": ["shock", "hypotension", "cardiogenic"] },
        { "id": "2.23", "name": "Smoke Inhalation - Adult", "page": 66, "keywords": ["smoke", "inhalation", "fire", "carbon monoxide"] },
        { "id": "2.24A", "name": "Smoke Inhalation - Pediatric", "page": 67, "keywords": ["smoke", "inhalation", "pediatric"] },
        { "id": "2.24P", "name": "Stroke - Adult & Pediatric", "page": 68, "keywords": ["stroke", "cva", "tia", "neuro"] },
        { "id": "2.25", "name": "Syncope - Adult/Pediatric", "page": 71, "keywords": ["syncope", "faint", "collapse"] },
        { "id": "2.26", "name": "Hospice", "page": 72, "keywords": ["hospice", "palliative", "end of life"] }
      ]
    },
    "cardiac": {
      "name": "Cardiac",
      "icon": `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
      "protocols": [
        { "id": "3.0", "name": "Cardiac Arrest - Adult", "page": 75, "keywords": ["cardiac arrest", "cpr", "code", "vfib", "asystole"] },
        { "id": "3.1A", "name": "Acute Coronary Syndrome - Adult", "page": 78, "keywords": ["acs", "mi", "stemi", "chest pain", "angina"] },
        { "id": "3.1P", "name": "Bradycardia - Adult", "page": 79, "keywords": ["bradycardia", "slow heart rate", "pacing"] },
        { "id": "3.2A", "name": "Bradycardia - Pediatric", "page": 80, "keywords": ["bradycardia", "pediatric"] },
        { "id": "3.2P", "name": "Cardiac Arrest - Pediatric", "page": 84, "keywords": ["cardiac arrest", "pediatric", "cpr"] },
        { "id": "3.3", "name": "Congestive Heart Failure (Pulmonary Edema)", "page": 86, "keywords": ["chf", "heart failure", "pulmonary edema", "cpap"] },
        { "id": "3.4", "name": "Post Resuscitative Care", "page": 87, "keywords": ["rosc", "post arrest", "therapeutic hypothermia"] },
        { "id": "3.5A", "name": "Tachycardia - Adult", "page": 88, "keywords": ["tachycardia", "svt", "afib", "fast heart rate"] },
        { "id": "3.5P", "name": "Tachycardia - Pediatric", "page": 90, "keywords": ["tachycardia", "pediatric", "svt"] }
      ]
    },
    "trauma": {
      "name": "Trauma",
      "icon": `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
      "protocols": [
        { "id": "4.0A", "name": "Burns (Thermal) - Adult", "page": 91, "keywords": ["burn", "thermal", "scald"] },
        { "id": "4.0P", "name": "Burns (Thermal) - Pediatric", "page": 93, "keywords": ["burn", "pediatric"] },
        { "id": "4.1", "name": "Drowning/Submersion Injuries - Adult & Pediatric", "page": 95, "keywords": ["drowning", "submersion", "water"] },
        { "id": "4.2", "name": "Eye & Dental Injuries - Adult & Pediatric", "page": 97, "keywords": ["eye", "dental", "tooth", "vision"] },
        { "id": "4.4", "name": "Shock - Trauma Adult & Pediatric", "page": 101, "keywords": ["shock", "trauma", "hemorrhage", "bleeding"] },
        { "id": "4.5", "name": "Spinal Trauma", "page": 103, "keywords": ["spinal", "spine", "c-spine", "immobilization"] },
        { "id": "4.6", "name": "Thoracic Injuries - Adult & Pediatric", "page": 107, "keywords": ["chest", "thoracic", "pneumothorax", "flail chest"] },
        { "id": "4.7", "name": "Traumatic Brain Injury - Adult & Pediatric", "page": 111, "keywords": ["tbi", "head injury", "concussion"] }
      ]
    },
    "airway": {
      "name": "Airway",
      "icon": `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 110 20A10 10 0 0112 2z"/><path d="M12 8v4l3 3"/></svg>`,
      "protocols": [
        { "id": "5.1", "name": "CPAP", "page": 129, "keywords": ["cpap", "respiratory", "chf"] },
        { "id": "5.7", "name": "Gum Elastic Bougie", "page": 131, "keywords": ["bougie", "intubation", "difficult airway"] },
        { "id": "5.8A", "name": "Nasotracheal Intubation", "page": 135, "keywords": ["nasotracheal", "intubation"] },
        { "id": "5.8P", "name": "Rapid Sequence Intubation (RSI) - Adult", "page": 138, "keywords": ["rsi", "intubation", "sedation"] },
        { "id": "5.9", "name": "Rapid Sequence Intubation (RSI) - Pediatric", "page": 139, "keywords": ["rsi", "pediatric", "intubation"] },
        { "id": "5.10", "name": "Suctioning of Inserted Airway", "page": 141, "keywords": ["suction", "airway"] },
        { "id": "5.11", "name": "Supraglottic Airway - Adult/Pediatric", "page": 143, "keywords": ["king", "lma", "supraglottic"] },
        { "id": "5.12", "name": "Tracheostomy Care", "page": 145, "keywords": ["trach", "tracheostomy"] }
      ]
    }
  },
  
  "callTypeMapping": {
    "lift_assist": {
      "primary": ["4.4", "4.5"],
      "secondary": ["2.25"],
      "quickReference": {
        "assessment": ["Mechanism of fall", "LOC changes", "C-spine evaluation", "Extremity injuries"],
        "interventions": ["C-spine precautions if indicated", "Assess for spinal tenderness", "Vitals", "GCS"],
        "redFlags": ["Head strike", "Neurological changes", "Neck/back pain", "Age >65"]
      }
    },
    "chest_pain": {
      "primary": ["3.1A", "3.0"],
      "secondary": ["3.3", "2.5A"],
      "quickReference": {
        "assessment": ["OPQRST", "Cardiac history", "Risk factors", "12-lead if available"],
        "interventions": ["Aspirin 324mg (if no contraindications)", "Oxygen if hypoxic", "IV access", "Nitro per protocol"],
        "redFlags": ["Inferior STEMI (check right-sided leads)", "Age >35 with chest pain", "Radiation to jaw/arm"]
      }
    },
    "respiratory": {
      "primary": ["2.5A", "2.5P", "3.3"],
      "secondary": ["5.1", "2.23", "2.24A"],
      "quickReference": {
        "assessment": ["Work of breathing", "Lung sounds", "SpO2", "History (asthma/COPD)"],
        "interventions": ["Position of comfort", "Oxygen", "Albuterol/Atrovent", "CPAP if indicated"],
        "redFlags": ["Silent chest", "Tripod positioning", "SpO2 <90%", "Altered mental status"]
      }
    },
    "trauma": {
      "primary": ["4.4", "4.5", "4.6", "4.7"],
      "secondary": ["4.0A", "4.2"],
      "quickReference": {
        "assessment": ["Mechanism", "C-spine", "Hemorrhage control", "Rapid trauma assessment"],
        "interventions": ["Spinal precautions", "Hemorrhage control", "IV access if shock", "Trauma center criteria"],
        "redFlags": ["Penetrating injuries to head/neck/torso", "GCS <14", "Unstable vitals", "Multi-system trauma"]
      }
    },
    "diabetic": {
      "primary": ["2.12A", "2.12P", "2.9"],
      "secondary": ["2.25"],
      "quickReference": {
        "assessment": ["Blood glucose", "Last meal/insulin", "Mental status", "History of diabetes"],
        "interventions": ["If BG <70: Oral glucose/D10/D50 per protocol", "If BG >250: IV fluids", "Reassess after treatment"],
        "redFlags": ["Altered LOC with low glucose", "Signs of DKA (fruity breath, Kussmaul)", "Unable to maintain airway"]
      }
    },
    "mva": {
      "primary": ["4.5", "4.4", "4.7"],
      "secondary": ["4.6", "4.0A"],
      "quickReference": {
        "assessment": ["Mechanism details", "Vehicle damage", "Airbag deployment", "Rapid trauma assessment"],
        "interventions": ["C-spine precautions", "Extrication plan", "Trauma center criteria evaluation"],
        "redFlags": ["Ejection", "Death in same vehicle", "Rollover", "High-speed collision", "Pedestrian struck"]
      }
    }
  }
};

// ======== DETAILED PROTOCOL CONTENT ========
const PROTOCOL_DETAILS = {
  "3.1A": {
    "id": "3.1A", "name": "Acute Coronary Syndrome - Adult", "section": "Cardiac", "page": 78,
    "indications": ["Chest pain/discomfort", "Suspected cardiac ischemia", "STEMI identified on 12-lead ECG"],
    "assessment": ["OPQRST history", "Cardiac risk factors", "12-lead ECG (if available)", "Vital signs", "Lung sounds", "Signs of CHF"],
    "treatment": {
      "EMT": ["Position of comfort (typically sitting up)", "Oxygen if SpO2 <94% or respiratory distress", "Aspirin 324mg PO (chew) if no contraindications", "Assist with patient's own nitroglycerin if prescribed", "Rapid transport"],
      "AEMT": ["All EMT interventions", "IV access", "Nitroglycerin 0.4mg SL (if SBP >100)", "May repeat q5min x3 doses"],
      "Paramedic": ["All AEMT interventions", "12-lead ECG with transmission", "If STEMI: Alert receiving hospital", "Consider additional nitrates", "Pain management per protocol"]
    },
    "contraindications": ["Nitroglycerin: SBP <100, HR <50 or >150, RV infarct, recent PDE-5 inhibitor use", "Aspirin: Known allergy, active GI bleeding"],
    "redFlags": ["Inferior STEMI - obtain right-sided leads (check for RV involvement)", "Hypotension with chest pain", "New onset left bundle branch block", "Cardiogenic shock"],
    "notes": ["Time is muscle - minimize scene time", "STEMI destination protocols may apply", "Consider age >35 for cardiac workup with chest pain"]
  },
  "2.12A": {
    "id": "2.12A", "name": "Hypoglycemia - Adult", "section": "Medical", "page": 40,
    "indications": ["Blood glucose <70 mg/dL", "Altered mental status with suspected hypoglycemia", "Diabetic patient with symptoms"],
    "assessment": ["Blood glucose level", "Mental status/GCS", "Last meal and insulin/medication history", "Signs of trauma from fall/seizure", "Ability to protect airway"],
    "treatment": {
      "EMT": ["If alert and able to swallow: Oral glucose 15-20g", "Position to protect airway if altered", "Monitor for improvement"],
      "AEMT": ["All EMT interventions", "If unable to swallow: D10 IV 10-25g (100-250mL) over 10 minutes", "Recheck glucose after treatment", "May repeat if BG remains <70"],
      "Paramedic": ["All AEMT interventions", "Alternative: D50 IV 12.5-25g (25-50mL)", "If no IV access: Glucagon 1mg IM"]
    },
    "contraindications": ["Oral glucose: Unable to swallow, unconscious, unable to protect airway"],
    "redFlags": ["Prolonged hypoglycemia despite treatment", "Suspected overdose of long-acting insulin", "Seizure activity", "Unable to maintain airway"],
    "notes": ["Recheck glucose 10-15 minutes after treatment", "Patient must eat complex carbohydrates before non-transport", "Consider underlying cause - missed meal, too much insulin, illness", "Glucagon will not work if glycogen stores depleted (chronic alcoholic)"]
  },
  "3.0": {
    "id": "3.0", "name": "Cardiac Arrest - Adult", "section": "Cardiac", "page": 75,
    "indications": ["Pulseless, apneic patient", "Ventricular fibrillation", "Pulseless ventricular tachycardia", "Asystole", "Pulseless electrical activity (PEA)"],
    "assessment": ["Confirm pulselessness", "Identify rhythm on monitor", "Consider reversible causes (H's and T's)"],
    "treatment": {
      "EMT": ["High-quality CPR - 30:2 ratio", "AED - analyze and shock if indicated", "Continue CPR immediately after shock", "Minimize interruptions in chest compressions"],
      "AEMT": ["All EMT interventions", "Advanced airway if trained", "IV/IO access", "Epinephrine 1mg IV/IO q3-5min"],
      "Paramedic": ["All AEMT interventions", "Advanced airway with capnography", "VF/pVT: Defibrillation - escalating energy", "Epinephrine 1mg IV/IO q3-5min", "Amiodarone 300mg IV/IO (first), then 150mg (second)", "Consider reversible causes"]
    },
    "reversibleCauses": {
      "Hs": ["Hypovolemia", "Hypoxia", "Hydrogen ion (acidosis)", "Hypo/hyperkalemia", "Hypothermia"],
      "Ts": ["Tension pneumothorax", "Tamponade (cardiac)", "Toxins", "Thrombosis (pulmonary)", "Thrombosis (coronary)"]
    },
    "redFlags": ["Prolonged downtime without CPR", "Signs of obvious death", "Valid DNR/MOLST", "Traumatic arrest (different protocol)"],
    "notes": ["Focus on high-quality CPR", "ETCO2 <10 mmHg indicates poor perfusion", "ROSC: See Post-Resuscitative Care protocol", "Consider termination of resuscitation per protocol"]
  },
  "2.5A": {
    "id": "2.5A", "name": "Asthma/COPD/RAD - Adult", "section": "Medical", "page": 27,
    "indications": ["Respiratory distress", "Wheezing", "Known asthma or COPD history", "Difficulty breathing"],
    "assessment": ["Work of breathing", "Lung sounds (wheezes, diminished)", "SpO2", "Ability to speak in full sentences", "Use of accessory muscles", "Tripod positioning"],
    "treatment": {
      "EMT": ["Position of comfort (usually sitting upright)", "Oxygen to maintain SpO2 >94%", "Assist with patient's own inhaler if prescribed", "Calm, reassuring approach"],
      "AEMT": ["All EMT interventions", "Albuterol 2.5mg nebulized (may repeat q20min)", "Consider Ipratropium 0.5mg added to albuterol", "IV access if severe"],
      "Paramedic": ["All AEMT interventions", "Continuous albuterol if severe", "Magnesium sulfate 2g IV over 10min if severe", "Epinephrine 0.3mg IM if impending respiratory failure", "Consider CPAP if CHF component", "Consider early intubation if failing"]
    },
    "contraindications": ["CPAP: Hypotension, inability to protect airway, pneumothorax"],
    "redFlags": ["Silent chest (critical)", "Altered mental status", "Exhaustion", "SpO2 <90% despite treatment", "Inability to speak", "Cyanosis"],
    "notes": ["Silent chest = impending respiratory arrest", "Don't withhold oxygen in COPD patients having respiratory distress", "Consider pneumothorax if unilateral decreased breath sounds", "Severity assessment: Mild (talking), Moderate (short sentences), Severe (words only)"]
  },
  "4.5": {
    "id": "4.5", "name": "Spinal Trauma", "section": "Trauma", "page": 103,
    "indications": ["Significant trauma with mechanism for spinal injury", "Altered mental status preventing reliable exam", "Neurological deficit", "Spinal pain or tenderness", "Anatomic deformity of spine"],
    "assessment": ["Mechanism of injury", "Neurological exam (motor, sensory)", "Spinal tenderness", "Reliability of patient", "Distracting injuries"],
    "treatment": {
      "EMT": ["Manual c-spine stabilization initially", "Maintain neutral alignment", "Apply cervical collar if indicated", "Immobilize to long board/scoop if needed", "Reassess neurological status frequently"],
      "AEMT": ["All EMT interventions", "IV access", "Pain management"],
      "Paramedic": ["All AEMT interventions", "Advanced pain management", "Consider medication-facilitated immobilization if combative"]
    },
    "clearanceCriteria": ["Must meet ALL criteria to clear spine:", "No midline spinal tenderness", "Normal neurological exam", "No intoxication", "No distracting injury", "No altered mental status", "Able to communicate clearly", "Age >3 years"],
    "redFlags": ["Neurological deficit", "High-risk mechanism (fall >3ft, MVC >35mph, ejection, rollover)", "Age >65", "Penetrating trauma to head/neck/torso"],
    "notes": ["Use clinical judgment - not all trauma requires immobilization", "Selective spinal immobilization is appropriate", "Document decision making if not immobilizing", "Maintain manual stabilization until patient secured"]
  },
  "4.4": {
    "id": "4.4", "name": "Shock - Trauma Adult & Pediatric", "section": "Trauma", "page": 101,
    "indications": ["Suspected hemorrhage", "Hypotension after trauma", "Signs of shock (tachycardia, altered mental status, cool/pale skin)"],
    "assessment": ["Identify source of bleeding", "Vital signs", "Mental status", "Skin signs (color, temperature, moisture)"],
    "treatment": {
      "EMT": ["Direct pressure for external bleeding", "Tourniquets for extremity hemorrhage not controlled by pressure", "Position patient supine", "Keep warm", "Rapid transport to trauma center"],
      "AEMT": ["All EMT interventions", "Large bore IV access x2", "Fluid resuscitation - permissive hypotension", "Target SBP 90mmHg (or return of radial pulse)"],
      "Paramedic": ["All AEMT interventions", "Consider IO access if IV difficult", "TXA 1g IV over 10min if within 3 hours of injury", "Blood products if available"]
    },
    "contraindications": ["Aggressive fluid resuscitation in uncontrolled hemorrhage"],
    "redFlags": ["Penetrating torso trauma", "Unstable pelvis", "Femur fracture", "Internal bleeding suspected", "Continued deterioration despite treatment"],
    "notes": ["Permissive hypotension - don't over-resuscitate", "Stop the bleeding first", "Rapid transport to trauma center", "TXA must be given within 3 hours of injury", "Reassess frequently"]
  }
};

// ======== PROTOCOLS SIDEBAR FUNCTIONS ========
let protocolsSidebarExpanded = {};

function toggleRefSection(bodyId, headerEl) {
  const body = document.getElementById(bodyId);
  if (!body) return;
  const toggle = headerEl.querySelector('.ref-section-toggle');
  const isHidden = body.style.display === 'none' || body.style.display === '';
  const displayVal = bodyId === 'refProtocolsBody' ? 'flex' : 'block';
  body.style.display = isHidden ? displayVal : 'none';
  if (toggle) toggle.style.transform = isHidden ? 'rotate(90deg)' : '';
  // Initialize protocols when first opened
  if (isHidden && bodyId === 'refProtocolsBody' && Object.keys(protocolsSidebarExpanded).length === 0) {
    initializeProtocolsSidebar();
  }
}

function toggleGuideCard(headerEl) {
  const body = headerEl.nextElementSibling;
  const toggle = headerEl.querySelector('.ref-guide-card-toggle');
  if (!body) return;
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  if (toggle) toggle.style.transform = isOpen ? '' : 'rotate(90deg)';
}

function toggleProtocolsSidebar() {
  const sidebar = document.getElementById('protocolsSidebar');
  const overlay = document.getElementById('protocolOverlay');
  const isOpen = sidebar.classList.contains('open');
  
  if (isOpen) {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
  } else {
    sidebar.classList.add('open');
    overlay.classList.add('active');
  }
}

function initializeProtocolsSidebar() {
  const content = document.getElementById('protocolsContent');
  let html = '';
  
  for (const [key, section] of Object.entries(CT_PROTOCOLS.sections)) {
    html += `
      <div class="protocol-section">
        <div class="protocol-section-header" onclick="toggleProtocolSection('${key}')">
          <span class="protocol-section-icon">${section.icon}</span>
          <span>${section.name}</span>
          <span class="protocol-section-toggle collapsed" id="toggle-${key}">‚ñ∂</span>
        </div>
        <div class="protocol-list" id="list-${key}">
    `;
    
    for (const protocol of section.protocols) {
      html += `
        <div class="protocol-item" onclick="viewProtocol('${protocol.id}')">
          <span class="protocol-item-id">${protocol.id}</span>
          <span>${protocol.name}</span>
        </div>
      `;
    }
    
    html += `
        </div>
      </div>
    `;
  }
  
  content.innerHTML = html;
}

function toggleProtocolSection(key) {
  const list = document.getElementById(`list-${key}`);
  const toggle = document.getElementById(`toggle-${key}`);
  
  if (list.classList.contains('expanded')) {
    list.classList.remove('expanded');
    if (toggle) toggle.style.transform = '';
    protocolsSidebarExpanded[key] = false;
  } else {
    list.classList.add('expanded');
    if (toggle) toggle.style.transform = 'rotate(90deg)';
    protocolsSidebarExpanded[key] = true;
  }
}

function searchProtocols(query) {
  if (!query.trim()) {
    // Reset to full list
    initializeProtocolsSidebar();
    return;
  }
  
  const lowerQuery = query.toLowerCase();
  const content = document.getElementById('protocolsContent');
  let html = '<div class="protocol-section"><div class="protocol-section-header" style="cursor:default;pointer-events:none;"><span class="protocol-section-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>Search Results</div><div class="protocol-list expanded">';
  
  let found = false;
  for (const [sKey, section] of Object.entries(CT_PROTOCOLS.sections)) {
    for (const protocol of section.protocols) {
      const matchesName = protocol.name.toLowerCase().includes(lowerQuery);
      const matchesId = protocol.id.toLowerCase().includes(lowerQuery);
      const matchesKeywords = protocol.keywords && protocol.keywords.some(k => k.includes(lowerQuery));
      
      if (matchesName || matchesId || matchesKeywords) {
        html += `
          <div class="protocol-item" onclick="viewProtocol('${protocol.id}')">
            <span class="protocol-item-id">${protocol.id}</span>
            <span>${protocol.name}</span>
          </div>
        `;
        found = true;
      }
    }
  }
  
  if (!found) {
    html += '<div style="padding:10px 16px 10px 42px;color:var(--text-dim);font-family:\'IBM Plex Mono\',monospace;font-size:11px;letter-spacing:0.03em;">No protocols found</div>';
  }
  
  html += '</div></div>';
  content.innerHTML = html;
}

function viewProtocol(protocolId) {
  // Check if we have detailed content for this protocol
  const details = PROTOCOL_DETAILS[protocolId];
  
  if (!details) {
    // Fallback: show PDF viewer even without detailed content
    let protocol = null;
    let sectionName = '';
    
    for (const [key, section] of Object.entries(CT_PROTOCOLS.sections)) {
      const found = section.protocols.find(p => p.id === protocolId);
      if (found) {
        protocol = found;
        sectionName = section.name;
        break;
      }
    }
    
    if (!protocol) {
      showToast('error', 'Protocol Not Found', 'Protocol ' + protocolId + ' not found');
      return;
    }
    
    // Show modal with just the PDF viewer
    document.getElementById('modalProtocolId').textContent = `Protocol ${protocol.id}`;
    document.getElementById('modalProtocolTitle').textContent = protocol.name;
    document.getElementById('modalProtocolMeta').textContent = `${sectionName} ‚Ä¢ Page ${protocol.page} ‚Ä¢ CT EMS v2025.1`;
    
    const html = `
      <div class="protocol-section">
        <div class="protocol-section-title">Official Protocol Document</div>
        <div style="padding: 12px; color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
          Click below to view the official CT EMS Protocol page ${protocol.page} with complete details, flowcharts, and medication dosing.
        </div>
      </div>
      <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 32px; text-align: center;">
        <p style="color: var(--text); margin-bottom: 20px; font-size: 15px; font-weight: 500;">
          üìÑ ${protocol.name}
        </p>
        <a href="${CT_PROTOCOLS_PDF_URL}#page=${protocol.page}" target="_blank" 
           style="display: inline-block; background: var(--accent); color: white; padding: 14px 28px; border-radius: 6px; text-decoration: none; font-family: var(--mono); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
          üìÑ Open Protocol PDF (Page ${protocol.page})
        </a>
        <p style="color: var(--text-dim); margin-top: 16px; font-size: 12px;">
          Opens official CT EMS Protocols v2025.1 in new tab
        </p>
      </div>
    `;
    
    document.getElementById('modalProtocolBody').innerHTML = html;
    document.getElementById('protocolModal').classList.add('active');
    return;
  }
  
  // Show detailed protocol modal
  document.getElementById('modalProtocolId').textContent = `Protocol ${details.id}`;
  document.getElementById('modalProtocolTitle').textContent = details.name;
  document.getElementById('modalProtocolMeta').textContent = `${details.section} ‚Ä¢ Page ${details.page} ‚Ä¢ CT EMS v2025.1`;
  
  // Build protocol content
  let html = '';
  
  // Indications
  if (details.indications && details.indications.length > 0) {
    html += '<div class="protocol-section"><div class="protocol-section-title">Indications</div>';
    details.indications.forEach(item => {
      html += `<div class="protocol-list-item">${item}</div>`;
    });
    html += '</div>';
  }
  
  // Assessment
  if (details.assessment && details.assessment.length > 0) {
    html += '<div class="protocol-section"><div class="protocol-section-title">Assessment</div>';
    details.assessment.forEach(item => {
      html += `<div class="protocol-list-item">${item}</div>`;
    });
    html += '</div>';
  }
  
  // Treatment by level
  if (details.treatment) {
    html += '<div class="protocol-section"><div class="protocol-section-title">Treatment</div>';
    
    if (details.treatment.EMT) {
      html += '<div class="protocol-treatment-level">';
      html += '<div class="protocol-treatment-level-title">EMT Level</div>';
      details.treatment.EMT.forEach(item => {
        html += `<div class="protocol-list-item">${item}</div>`;
      });
      html += '</div>';
    }
    
    if (details.treatment.AEMT) {
      html += '<div class="protocol-treatment-level">';
      html += '<div class="protocol-treatment-level-title">AEMT Level</div>';
      details.treatment.AEMT.forEach(item => {
        html += `<div class="protocol-list-item">${item}</div>`;
      });
      html += '</div>';
    }
    
    if (details.treatment.Paramedic) {
      html += '<div class="protocol-treatment-level">';
      html += '<div class="protocol-treatment-level-title">Paramedic Level</div>';
      details.treatment.Paramedic.forEach(item => {
        html += `<div class="protocol-list-item">${item}</div>`;
      });
      html += '</div>';
    }
    
    html += '</div>';
  }
  
  // Reversible Causes (for cardiac arrest)
  if (details.reversibleCauses) {
    html += '<div class="protocol-section"><div class="protocol-section-title">Reversible Causes</div>';
    html += '<div class="protocol-reversible-causes">';
    
    if (details.reversibleCauses.Hs) {
      html += '<div class="protocol-causes-column"><h4>H\'s</h4>';
      details.reversibleCauses.Hs.forEach(item => {
        html += `<div class="protocol-list-item">${item}</div>`;
      });
      html += '</div>';
    }
    
    if (details.reversibleCauses.Ts) {
      html += '<div class="protocol-causes-column"><h4>T\'s</h4>';
      details.reversibleCauses.Ts.forEach(item => {
        html += `<div class="protocol-list-item">${item}</div>`;
      });
      html += '</div>';
    }
    
    html += '</div></div>';
  }
  
  // Clearance Criteria (for spinal)
  if (details.clearanceCriteria && details.clearanceCriteria.length > 0) {
    html += '<div class="protocol-section"><div class="protocol-section-title">Spinal Clearance Criteria</div>';
    details.clearanceCriteria.forEach(item => {
      html += `<div class="protocol-list-item">${item}</div>`;
    });
    html += '</div>';
  }
  
  // Contraindications
  if (details.contraindications && details.contraindications.length > 0) {
    html += '<div class="protocol-section"><div class="protocol-section-title">Contraindications</div>';
    details.contraindications.forEach(item => {
      html += `<div class="protocol-list-item">${item}</div>`;
    });
    html += '</div>';
  }
  
  // Red Flags
  if (details.redFlags && details.redFlags.length > 0) {
    html += '<div class="protocol-section"><div class="protocol-section-title">‚ö† Red Flags</div>';
    details.redFlags.forEach(item => {
      html += `<div class="protocol-list-item red-flag">${item}</div>`;
    });
    html += '</div>';
  }
  
  // Notes
  if (details.notes && details.notes.length > 0) {
    html += '<div class="protocol-section"><div class="protocol-section-title">Clinical Notes</div>';
    details.notes.forEach(item => {
      html += `<div class="protocol-note">${item}</div>`;
    });
    html += '</div>';
  }
  
  // Add PDF Viewer showing the actual protocol page
  html += `
    <div class="pdf-viewer-container">
      <div class="pdf-viewer-header">
        <div class="pdf-viewer-title">üìÑ Official Protocol Page ${details.page}</div>
      </div>
      <div style="background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 24px; text-align: center;">
        <p style="color: var(--text); margin-bottom: 16px; font-size: 14px;">
          Click below to view the official CT EMS Protocol page ${details.page} with complete flowcharts and medication details.
        </p>
        <a href="${CT_PROTOCOLS_PDF_URL}#page=${details.page}" target="_blank" 
           style="display: inline-block; background: var(--accent); color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-family: var(--mono); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
          üìÑ Open Official Protocol PDF (Page ${details.page})
        </a>
        <p style="color: var(--text-dim); margin-top: 12px; font-size: 12px;">
          Opens in new tab ‚Ä¢ CT EMS v2025.1
        </p>
      </div>
    </div>
  `;
  
  document.getElementById('modalProtocolBody').innerHTML = html;
  document.getElementById('protocolModal').classList.add('active');
}

function closeProtocolModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('protocolModal').classList.remove('active');
}

// ======== QUICK REFERENCE CARD ========
// ======== QUICK REFERENCE CARD - now handled in merged updateCallType function below ========

window.onerror = function(msg, src, line, col, err) {
  const banner = document.getElementById('micStatusBanner');
  if (banner) {
    banner.style.display = 'block';
    banner.textContent = '‚ö† JS Error line ' + line + ': ' + msg;
  }
  console.error('[EMS ERROR]', msg, 'line:', line);
  return false;
};

// ======== TOAST NOTIFICATIONS ========
function showToast(type, title, msg, duration) {
  // type: 'success' | 'error' | 'warn' | 'info'
  duration = duration || 4000;
  const icons = { success: '‚úÖ', error: '‚ùå', warn: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
  const container = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.innerHTML = `<div class="toast-icon">${icons[type]||'‚ÑπÔ∏è'}</div><div class="toast-body"><div class="toast-title">${title}</div>${msg ? `<div class="toast-msg">${msg}</div>` : ''}</div>`;
  t.onclick = () => dismissToast(t);
  container.appendChild(t);
  const timer = setTimeout(() => dismissToast(t), duration);
  t._timer = timer;
}
function dismissToast(t) {
  clearTimeout(t._timer);
  t.classList.add('toast-out');
  setTimeout(() => t.remove(), 260);
}

// ======== CONFIRM MODAL ========
function showConfirm(title, msg, okLabel, okDanger, onOk, onCancel, cancelLabel) {
  const modal = document.getElementById('confirmModal');
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMsg').textContent = msg;
  const okBtn = document.getElementById('confirmOk');
  const cancelBtn = document.getElementById('confirmCancel');
  okBtn.textContent = okLabel || 'Confirm';
  cancelBtn.textContent = cancelLabel || 'Cancel';
  okBtn.style.background = okDanger !== false ? 'var(--danger)' : 'var(--accent)';
  okBtn.style.borderColor = okDanger !== false ? 'var(--danger)' : 'var(--accent)';
  modal.classList.add('show');
  const close = () => modal.classList.remove('show');
  okBtn.onclick = () => { close(); if (onOk) onOk(); };
  cancelBtn.onclick = () => { close(); if (onCancel) onCancel(); };
}

function showPasswordPrompt(title, msg, onOk, onCancel) {
  const modal = document.getElementById('passwordPromptModal');
  document.getElementById('passwordPromptTitle').textContent = title;
  document.getElementById('passwordPromptMsg').textContent = msg;
  document.getElementById('passwordPromptInput').value = '';
  document.getElementById('passwordPromptError').textContent = '';
  modal.classList.add('show');

  const close = () => {
    modal.classList.remove('show');
    document.getElementById('passwordPromptInput').value = '';
    document.getElementById('passwordPromptError').textContent = '';
  };

  document.getElementById('passwordPromptOk').onclick = () => {
    const pw = document.getElementById('passwordPromptInput').value.trim();
    if (!pw) {
      document.getElementById('passwordPromptError').textContent = 'Please enter a password.';
      return;
    }
    close();
    if (onOk) onOk(pw);
  };

  document.getElementById('passwordPromptCancel').onclick = () => {
    close();
    if (onCancel) onCancel();
  };

  setTimeout(() => document.getElementById('passwordPromptInput').focus(), 50);
}

// ======== INLINE AUTH MESSAGE ========
function showAuthMsg(id, type, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.className = `auth-msg ${type} show`;
  el.textContent = msg;
}
function clearAuthMsg(id) {
  const el = document.getElementById(id);
  if (el) { el.className = 'auth-msg'; el.textContent = ''; }
}

// ======== STATE ========
let settings = {};
let vitalsCount = 0;
let recognition = null;
let isRecording = false;
let outputGenerated = false;

// ======== OFFLINE EXTRACTION QUEUE ========
// Persists extractions that couldn't run because the device was offline.
// Each item: { id, section, type, transcripts, timestamp, status }
// type: 'universal' | 'vitals' | 'section'
// status: 'pending' | 'processing' | 'done' | 'error'

const QUEUE_KEY = 'ems_extraction_queue';
let extractionQueue = [];
let queueProcessing = false;

function loadQueue() {
  try {
    extractionQueue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
  } catch(e) { extractionQueue = []; }
}

function saveQueue() {
  try { localStorage.setItem(QUEUE_KEY, JSON.stringify(extractionQueue)); } catch(e) {}
}

function isOnline() {
  return navigator.onLine !== false;
}

function pendingQueueItems() {
  return extractionQueue.filter(i => i.status === 'pending');
}

function updateQueueBanner() {
  const banner = document.getElementById('offlineQueueBanner');
  const msg = document.getElementById('offlineQueueMsg');
  if (!banner || !msg) return;
  const pending = pendingQueueItems();
  if (pending.length === 0) {
    banner.style.display = 'none';
    return;
  }
  if (isOnline()) {
    msg.textContent = `üåê Network restored ‚Äî ${pending.length} pending extraction${pending.length !== 1 ? 's' : ''} queued. Tap to extract now ‚Üí`;
    banner.style.background = '#1c2a1c';
    banner.style.color = '#3fb950';
  } else {
    msg.textContent = `üì∂ Offline ‚Äî ${pending.length} transcript${pending.length !== 1 ? 's' : ''} queued for extraction when network is available`;
    banner.style.background = '#1e1e2a';
    banner.style.color = '#7d8590';
  }
  banner.style.display = 'block';
}

// Add a transcript to the extraction queue
function queueExtraction(section, type, transcripts) {
  const id = Date.now() + '-' + Math.random().toString(36).slice(2, 7);
  extractionQueue.push({ id, section, type, transcripts: [...transcripts], timestamp: Date.now(), status: 'pending' });
  saveQueue();
  updateQueueBanner();
}

// Process all pending queue items (runs when online)
async function processExtractionQueue() {
  if (queueProcessing) return;
  if (!isOnline()) { updateQueueBanner(); return; }
  if (!hasAnthropicKey()) {
    showToast('warn', 'API Key Needed', 'Add your Anthropic API key in ‚öô Crew settings to process queued extractions.');
    return;
  }
  const pending = pendingQueueItems();
  if (pending.length === 0) { updateQueueBanner(); return; }

  queueProcessing = true;
  showToast('info', 'Processing Queue', `Running ${pending.length} pending extraction${pending.length !== 1 ? 's' : ''}‚Ä¶`);

  for (const item of pending) {
    item.status = 'processing';
    saveQueue();
    try {
      const combined = item.transcripts.join(' ').trim();
      if (item.type === 'vitals') {
        await runVitalsExtraction(combined, item.section);
      } else if (item.type === 'section') {
        await runSectionExtraction(combined, item.section);
      } else {
        // universal ‚Äî maps to a named section extractor
        await runUniversalExtraction(combined, item.section);
      }
      item.status = 'done';
      saveQueue();
      // Update the status element for this section
      updateSectionStatusAfterQueue(item.section, combined);
    } catch(err) {
      item.status = 'error';
      item.error = err.message;
      saveQueue();
      showToast('error', 'Extraction Failed', `${item.section}: ${err.message}`);
    }
  }

  queueProcessing = false;
  const stillPending = pendingQueueItems();
  if (stillPending.length === 0) {
    showToast('success', 'All Extractions Complete', 'All queued transcripts have been extracted into fields.');
    // Clean up done items older than 24h
    extractionQueue = extractionQueue.filter(i => i.status !== 'done' || (Date.now() - i.timestamp) < 86400000);
    saveQueue();
  }
  updateQueueBanner();
}

// Run extraction for a universal section (patient, scene, incident, transport)
async function runUniversalExtraction(transcript, section) {
  const result = await extractUniversalInfo(transcript, section);
  if (!result.success && result.error !== 'no_key') throw new Error(result.error);
}

// Run extraction for vitals section
async function runVitalsExtraction(transcript, section) {
  // Re-use the same vitals extraction logic ‚Äî set the global var temporarily
  const prev = vitalsTranscript;
  vitalsTranscript = transcript;
  await extractVitalsInfo();
  vitalsTranscript = prev;
}

// Run extraction for a generic section (calltype etc)
async function runSectionExtraction(transcript, section) {
  const prev = secTranscript[section] || '';
  secTranscript[section] = transcript;
  await extractSection(section);
  secTranscript[section] = prev;
}

// Update the status element for a section after successful queue processing
function updateSectionStatusAfterQueue(section, transcript) {
  const statusMap = {
    patient: 'ptExtractStatus',
    scene: 'sceneExtractStatus',
    incident: 'incidentExtractStatus',
    vitals: 'vitalsExtractStatus',
    transport: 'transportExtractStatus',
  };
  const elId = statusMap[section];
  if (elId) {
    const el = document.getElementById(elId);
    if (el) { el.textContent = '‚úì Extracted from queued transcript ‚Äî review fields'; el.style.color = 'var(--success)'; }
  }
}

// Called instead of directly running extract when offline
// Returns true if queued (offline), false if should proceed normally (online)
function maybeQueueExtraction(section, type, transcripts) {
  if (isOnline() && hasAnthropicKey()) return false; // proceed normally
  if (!hasAnthropicKey()) {
    // No key at all ‚Äî queue it for when key is entered AND online
    queueExtraction(section, type, transcripts);
    return true;
  }
  // Offline but has key ‚Äî queue for when network returns
  queueExtraction(section, type, transcripts);
  return true;
}

// Listen for network restoration
window.addEventListener('online', () => {
  updateQueueBanner();
  // Auto-process if we have a key and pending items
  if (hasAnthropicKey() && pendingQueueItems().length > 0) {
    setTimeout(processExtractionQueue, 1500); // brief delay to let connection stabilize
  }
});
window.addEventListener('offline', () => { updateQueueBanner(); });

// ======== AUDIO VISUALIZER ========
let vizAudioCtx = null, vizAnalyser = null, vizStream = null, vizAnimId = null;

// startVisualizer ‚Äî NEVER opens its own getUserMedia.
// It reuses whisperStream (Whisper mode) or sharedMicStream (WebSpeech mode).
// This prevents the double-getUserMedia that breaks iPhone Safari.
async function startVisualizer(canvasId) {
  stopVisualizer();
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  // Pick the already-open mic stream: Whisper owns whisperStream, WebSpeech uses sharedMicStream
  const stream = whisperStream || sharedMicStream;
  if (!stream) return;  // no stream available ‚Äî skip silently

  try {
    vizAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    vizAnalyser = vizAudioCtx.createAnalyser();
    vizAnalyser.fftSize = 64;
    vizAudioCtx.createMediaStreamSource(stream).connect(vizAnalyser);
    const buf = new Uint8Array(vizAnalyser.frequencyBinCount);
    const ctx = canvas.getContext('2d');
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#f97316';

    function draw() {
      vizAnimId = requestAnimationFrame(draw);
      vizAnalyser.getByteFrequencyData(buf);
      const W = canvas.width = canvas.offsetWidth;
      const H = canvas.height = canvas.offsetHeight;
      ctx.clearRect(0, 0, W, H);
      const total = buf.length;
      const slotW = W / total;
      const barW = Math.max(2, Math.floor(slotW * 0.7));
      for (let i = 0; i < total; i++) {
        const v = buf[i] / 255;
        const h = Math.max(3, v * H * 0.9);
        const x = i * slotW + (slotW - barW) / 2;
        ctx.fillStyle = accentColor;
        ctx.globalAlpha = 0.4 + v * 0.6;
        ctx.beginPath();
        ctx.roundRect(x, (H - h) / 2, barW, h, 2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }
    draw();
    canvas.style.display = 'block';
  } catch(e) {
    // Visualizer failure is non-fatal ‚Äî recording still works
  }
}

function stopVisualizer() {
  if (vizAnimId) { cancelAnimationFrame(vizAnimId); vizAnimId = null; }
  // Do NOT stop vizStream ‚Äî we don't own it (whisperStream or sharedMicStream does)
  vizStream = null;
  if (vizAudioCtx) { try { vizAudioCtx.close(); } catch(e) {} vizAudioCtx = null; }
  vizAnalyser = null;
}

// WebSpeech owns the mic internally ‚Äî we must NEVER call getUserMedia while it's active.
// These are intentional no-ops. The call sites are kept so diffs stay minimal.
let sharedMicStream = null;
async function acquireSharedMic() { /* no-op: WebSpeech manages mic itself */ }
function releaseSharedMic() { /* no-op */ }

// Level meter (text bar) ‚Äî reuses whisperStream, no extra getUserMedia needed.
// Only used in Whisper mode (setDictateState already gates on useWhisper()).
let levelAnimId = null;
function startLevelMeter(section) {
  stopLevelMeter();
  const stream = whisperStream;
  if (!stream) return;
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 256;
    ctx.createMediaStreamSource(stream).connect(analyser);
    const buf = new Uint8Array(analyser.fftSize);
    const bars = '‚ñÅ‚ñÇ‚ñÉ‚ñÑ‚ñÖ‚ñÜ‚ñá‚ñà';
    function tick() {
      levelAnimId = requestAnimationFrame(tick);
      analyser.getByteTimeDomainData(buf);
      let sum = 0;
      for (let i = 0; i < buf.length; i++) sum += Math.pow((buf[i] - 128) / 128, 2);
      const rms = Math.sqrt(sum / buf.length);
      const idx = Math.min(7, Math.floor(rms * 40));
      const el = document.getElementById('sec-level-' + section);
      if (el) el.textContent = bars[idx].repeat(5);
      else { ctx.close(); stopLevelMeter(); }
    }
    tick();
  } catch(e) { /* non-fatal */ }
}
function stopLevelMeter() {
  if (levelAnimId) { cancelAnimationFrame(levelAnimId); levelAnimId = null; }
}

// ======== INIT ========
window.onload = function() {
  console.log('[EMS] onload starting');
  
  // Check if user is logged in - if not, show login screen
  checkLogin();
  
  loadSettings();
  loadAccount();
  updateCallType();  // This will call initializeActivityCards
  setCurrentTimes();
  checkMicPermission();

  // Load and display any pending offline extractions
  loadQueue();
  updateQueueBanner();
  
  // Attach auto-save listeners to all inputs
  attachAutoSaveListeners();

  // Wire up and resize all textareas
  initAutoResize();

  // Suppress iOS Safari autofill on all non-login fields
  suppressAutofill();
  
  // Click outside menu to close
  document.addEventListener('click', function(e) {
    const menu = document.getElementById('hamburgerMenu');
    const menuButton = document.getElementById('menuButton');
    if (menu && menu.classList.contains('active') && !menu.contains(e.target) && e.target !== menuButton) {
      toggleMenu();
    }
  });

  // Wire mic buttons via addEventListener (more reliable in Safari than onclick attributes)
  ['calltype','vitals','interventions','transport','refusal'].forEach(section => {
    const btn = document.getElementById('sec-mic-' + section);
    if (btn) {
      btn.removeAttribute('onclick');
      btn.addEventListener('mousedown', function(e) {
      });
      btn.addEventListener('touchstart', function(e) {
      });
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        toggleSectionDictate(section);
      });
    }
  });

  console.log('[EMS] onload complete');
};

function checkMicPermission() {
  if (window.location.protocol === 'file:') {
    showMicBanner('‚ö† Must be served over http. Open Terminal: cd to file folder, run: python3 -m http.server 8080  then open http://localhost:8080');
    return;
  }
  // Do NOT call getUserMedia here on iOS Safari ‚Äî it opens and immediately closes the
  // audio session, which poisons the Web Speech API audio session for the rest of the
  // page lifetime (recognizer fires onend immediately with no results).
  // Instead, check permissions passively via the Permissions API if available.
  if (navigator.permissions && navigator.permissions.query) {
    navigator.permissions.query({ name: 'microphone' }).then(result => {
      if (result.state === 'denied') {
        showMicBanner('‚ö† Microphone access denied. Settings ‚Üí Safari ‚Üí Microphone ‚Üí Allow.');
      }
    }).catch(() => { /* Permissions API not fully supported ‚Äî ignore */ });
  }
}

function showMicBanner(msg) {
  const b = document.getElementById('micStatusBanner');
  b.textContent = msg;
  // If it's the file:// error, add a copy-command button
  if (msg.includes('python3')) {
    const btn = document.createElement('button');
    btn.textContent = '  Copy Command';
    btn.style.cssText = 'margin-left:12px;background:#f97316;color:#fff;border:none;border-radius:4px;padding:3px 10px;font-family:var(--mono);font-size:11px;cursor:pointer;vertical-align:middle';
    btn.onclick = () => { navigator.clipboard.writeText('python3 -m http.server 8080'); btn.textContent = '‚úì Copied!'; };
    b.appendChild(btn);
  }
  b.style.display = 'block';
}

function hideMicBanner() {
  document.getElementById('micStatusBanner').style.display = 'none';
}

function setCurrentTimes() {
  const now = new Date();
  const hhmm = now.toTimeString().slice(0,5);
  // Leave blank for user to fill
}

// ======== TABS ========
const TAB_ORDER = ['dispatch', 'input', 'reference', 'output', 'refusal'];

function switchTab(tab, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (el) {
    el.classList.add('active');
  } else {
    // Find and activate the matching tab button
    const idx = TAB_ORDER.indexOf(tab);
    document.querySelectorAll('.tab')[idx]?.classList.add('active');
  }
  document.getElementById('tab-dispatch').style.display  = tab === 'dispatch'  ? 'block' : 'none';
  document.getElementById('tab-input').style.display     = tab === 'input'     ? 'block' : 'none';
  document.getElementById('tab-reference').style.display = tab === 'reference' ? 'block' : 'none';
  document.getElementById('tab-output').style.display    = tab === 'output'    ? 'block' : 'none';
  document.getElementById('tab-refusal').style.display   = tab === 'refusal'   ? 'block' : 'none';

  if (tab === 'output' && !outputGenerated) {
    document.getElementById('outputEmpty').style.display = 'block';
  }
  if (tab === 'refusal') {
    prefillRefusalForm();
    setTimeout(initSignaturePads, 100);
  }
}

// ======== SWIPE GESTURE ‚Äî TAB NAVIGATION ========
(function initSwipeGesture() {
  let touchStartX = 0;
  let touchStartY = 0;
  let touchStartTime = 0;
  const SWIPE_THRESHOLD = 60;   // min px horizontal travel
  const SWIPE_MAX_Y = 80;       // max vertical drift allowed
  const SWIPE_MAX_MS = 400;     // max gesture duration

  document.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    touchStartTime = Date.now();
  }, { passive: true });

  document.addEventListener('touchend', (e) => {
    const dx = e.changedTouches[0].clientX - touchStartX;
    const dy = e.changedTouches[0].clientY - touchStartY;
    const dt = Date.now() - touchStartTime;

    if (Math.abs(dx) < SWIPE_THRESHOLD) return;
    if (Math.abs(dy) > SWIPE_MAX_Y) return;
    if (dt > SWIPE_MAX_MS) return;
    // Ignore swipes that start on interactive controls (inputs, selects, buttons, canvases)
    const tag = (e.target || document.elementFromPoint(touchStartX, touchStartY))?.tagName?.toLowerCase();
    if (['input','select','textarea','button','canvas'].includes(tag)) return;

    const activeTab = document.querySelector('.tab.active');
    const tabs = Array.from(document.querySelectorAll('.tab'));
    const currentIdx = tabs.indexOf(activeTab);

    let nextIdx;
    if (dx < 0) {
      // Swipe left ‚Üí go forward
      nextIdx = Math.min(currentIdx + 1, tabs.length - 1);
    } else {
      // Swipe right ‚Üí go back
      nextIdx = Math.max(currentIdx - 1, 0);
    }

    if (nextIdx !== currentIdx) {
      switchTab(TAB_ORDER[nextIdx], tabs[nextIdx]);
      // Scroll to top of content area smoothly
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }, { passive: true });
})();

// ======== TAP PILL HELPERS ========

function selectWhoCalledPill(btn, value) {
  document.querySelectorAll('#whoCalled911Pills .tap-pill').forEach(p => p.classList.remove('selected'));
  btn.classList.add('selected');
  const otherInput = document.getElementById('whoCalled911Other');
  const hidden = document.getElementById('whoCalled911');
  if (value === 'Other') {
    otherInput.style.display = 'block';
    otherInput.focus();
    otherInput.oninput = () => { hidden.value = otherInput.value; };
    hidden.value = otherInput.value || '';
  } else {
    otherInput.style.display = 'none';
    hidden.value = value;
  }
}

function selectSexPill(btn, value) {
  btn.closest('.pill-group').querySelectorAll('.tap-pill').forEach(p => p.classList.remove('selected'));
  btn.classList.add('selected');
  document.getElementById('patientSex').value = value;
}

let locAlertValue = '';
let locOrientedValues = new Set();

function selectLocAlert(btn, value) {
  document.querySelectorAll('#locAlertPills .tap-pill').forEach(p => p.classList.remove('selected'));
  btn.classList.add('selected');
  locAlertValue = value;
  const orientedGroup = document.getElementById('locOrientedGroup');
  if (value === 'Alert') {
    orientedGroup.style.display = 'block';
  } else {
    orientedGroup.style.display = 'none';
    locOrientedValues.clear();
    document.querySelectorAll('#locOrientedPills .tap-pill').forEach(p => p.classList.remove('selected'));
  }
  updateLocHidden();
}

function toggleLocOriented(btn, value) {
  if (locOrientedValues.has(value)) {
    locOrientedValues.delete(value);
    btn.classList.remove('selected');
  } else {
    locOrientedValues.add(value);
    btn.classList.add('selected');
  }
  updateLocHidden();
}

function updateLocHidden() {
  let display = locAlertValue;
  if (locAlertValue === 'Alert' && locOrientedValues.size > 0) {
    // Build "Alert and Oriented to Person, Place, Time, and Event" style string
    const order = ['Person','Place','Time','Event'];
    const selected = order.filter(v => locOrientedValues.has(v));
    display = 'Alert and Oriented x' + selected.length;
  }
  document.getElementById('patientLOC').value = display;
}

// ======== SECTIONS ========
function toggleSection(id) {
  const el = document.getElementById('section-' + id);
  const badge = document.getElementById(id + '-badge');
  if (el.style.display === 'none') {
    el.style.display = 'block';
    badge.textContent = '‚ñæ';
  } else {
    el.style.display = 'none';
    badge.textContent = '‚ñ∏';
  }
}

// ======== CALL TYPE ========
function updateCallType() {
  // Update Quick Reference Card on Dispatch tab
  const callType = document.getElementById('callType').value;
  const container = document.getElementById('quickRefContainer');
  
  if (!callType || !CT_PROTOCOLS.callTypeMapping[callType]) {
    if (container) container.innerHTML = '';
  } else if (container) {
    const ref = CT_PROTOCOLS.callTypeMapping[callType].quickReference;
    const primaryProtocols = CT_PROTOCOLS.callTypeMapping[callType].primary || [];
    
    let html = `
      <div class="quick-ref-card">
        <div class="quick-ref-header">üìã Protocol Quick Reference</div>
        
        <div class="quick-ref-subsection">
          <div class="quick-ref-label">Assessment Focus</div>
          <ul class="quick-ref-list">
    `;
    
    for (const item of ref.assessment || []) {
      html += `<li>${item}</li>`;
    }
    
    html += `
          </ul>
        </div>
        
        <div class="quick-ref-subsection">
          <div class="quick-ref-label">Expected Interventions</div>
          <ul class="quick-ref-list">
    `;
    
    for (const item of ref.interventions || []) {
      html += `<li>${item}</li>`;
    }
    
    html += `
          </ul>
        </div>
        
        <div class="quick-ref-subsection">
          <div class="quick-ref-label">‚ö† Red Flags</div>
          <ul class="quick-ref-list red-flags">
    `;
    
    for (const item of ref.redFlags || []) {
      html += `<li>${item}</li>`;
    }
    
    html += `
          </ul>
        </div>
        
        <div class="quick-ref-footer">
          <button class="btn-protocol-link" onclick="toggleProtocolsSidebar()">View Full Protocols ‚Üí</button>
        </div>
      </div>
    `;
    
    container.innerHTML = html;
  }
  
  // Initialize activity cards (same structure for all call types now)
  initializeActivityCards();
}

// ======== BP SMART FORMAT ========
// Rules:
//   - Digits only ‚Üí auto-inserts "/" after systolic when safe to do so
//   - Space bar acts as "/" (keydown handler below)
//   - Auto-slash fires after 3 digits only if systolic ‚â• 100 (i.e. starts with 1 or 2)
//   - For systolics < 100 (e.g. 80, 90), user types space or "/" to split
//   - Backspace past slash removes it cleanly

// Auto-format temperature: digits-only entry, insert decimal on blur
// e.g. "986" ‚Üí "98.6", "1000" ‚Üí "100.0", "975" ‚Üí "97.5"
function formatTempOnBlur(el) {
  const raw = el.value.replace(/[^0-9]/g, '');
  if (!raw) return;
  const n = parseInt(raw, 10);
  // Reasonable range: 850‚Äì1150 (entered as 850=85.0 to 1150=115.0)
  // If user typed 3 digits treat last as tenths: 986 ‚Üí 98.6
  // If user typed 4 digits treat last as tenths: 1004 ‚Üí 100.4
  if (raw.length >= 3) {
    const intPart  = raw.slice(0, -1);
    const tenths   = raw.slice(-1);
    const val = parseFloat(intPart + '.' + tenths);
    if (val >= 85.0 && val <= 115.0) {
      el.value = val.toFixed(1);
      return;
    }
  }
  // Fallback: leave as-is if can't make sense of it
  el.value = raw;
}

function formatBPInput(el) {
  let raw = el.value;

  // Strip everything except digits and slash
  let clean = raw.replace(/[^\d\/]/g, '');

  // If a slash is already present, normalize both sides
  if (clean.includes('/')) {
    const parts = clean.split('/');
    const sys = parts[0].slice(0, 3);
    const dia = (parts[1] || '').slice(0, 3);
    el.value = `${sys}/${dia}`;
    return;
  }

  // Digits only ‚Äî decide whether to auto-insert slash
  const digits = clean.slice(0, 6);
  const firstDigit = parseInt(digits[0], 10);

  if (digits.length >= 3 && firstDigit >= 1) {
    // Only auto-slash after 3 digits if systolic is plausibly ‚â• 100
    // (first digit 1 or 2 covers 100‚Äì299 range)
    if (firstDigit >= 1 && parseInt(digits.slice(0, 3), 10) >= 100) {
      const sys = digits.slice(0, 3);
      const dia = digits.slice(3, 6);
      el.value = `${sys}/${dia}`;
      if (dia.length === 0) {
        // Place cursor right after slash
        const pos = sys.length + 1;
        el.setSelectionRange(pos, pos);
      }
      return;
    }
  }

  // Otherwise just show the raw digits (waiting for manual slash/space)
  el.value = digits;
}

function handleBPKeydown(el, e) {
  // Space bar ‚Üí insert slash as separator
  if (e.key === ' ' || e.code === 'Space') {
    e.preventDefault();
    const raw = el.value.replace(/[^\d\/]/g, '');
    if (!raw.includes('/') && raw.length > 0) {
      el.value = raw + '/';
      const pos = el.value.length;
      el.setSelectionRange(pos, pos);
    }
  }
}

